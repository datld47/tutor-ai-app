<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Tutor Chat</title>
    
    <script>
        // Hàng đợi để chứa các phần tử DOM cần được MathJax render
        let mathJaxRenderQueue = [];
        let isMathJaxReady = false;

        // Cấu hình MathJax
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            startup: {
                // Hàm này sẽ được gọi khi MathJax đã sẵn sàng
                ready: () => {
                    console.log('✅ MathJax is fully ready.');
                    isMathJaxReady = true;
                    MathJax.startup.defaultReady();
                    // Ngay khi sẵn sàng, xử lý ngay hàng đợi
                    processMathJaxQueue();
                }
            }
        };

        // Hàm xử lý hàng đợi
        function processMathJaxQueue() {
            if (!isMathJaxReady || mathJaxRenderQueue.length === 0) {
                return;
            }
            console.log(`Processing ${mathJaxRenderQueue.length} items in MathJax queue.`);
            // Yêu cầu MathJax render các phần tử trong hàng đợi
            MathJax.typesetPromise(mathJaxRenderQueue).then(() => {
                // Xóa hàng đợi sau khi đã render xong
                mathJaxRenderQueue = [];
            }).catch((err) => console.error('MathJax typesetting error:', err));
        }
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

    <style>
        body { font-family: Verdana, sans-serif; font-size: 16px; margin: 0; padding: 0; }
        .chat-container { padding: 10px; }
        .message { 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            padding: 10px; 
            background-color: #f9f9f9;
        }
        .message-header { 
            font-weight: bold; 
            color: #0056b3; 
            margin-bottom: 8px; 
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }
        .message-content { word-wrap: break-word; }
        pre { 
            background-color: #f0f0f0; 
            padding: 10px; 
            border-radius: 5px; 
            white-space: pre-wrap; 
            word-wrap: break-word; 
            border: 1px solid #e0e0e0;
        }
        code { font-family: 'Courier New', Courier, monospace; }
    </style>
</head>
<body>
    <div id="chat-container"></div>

    <script>
        const chatContainer = document.getElementById('chat-container');

        // Hàm này sẽ được gọi từ Python
        function addMessage(htmlContent, messageType) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            let headerHtml = messageType ? `<div class="message-header">${messageType}</div>` : '';
            messageDiv.innerHTML = `${headerHtml}<div class="message-content">${htmlContent}</div>`;
            
            chatContainer.appendChild(messageDiv);
            
            // 1. Thêm phần tử mới vào hàng đợi
            mathJaxRenderQueue.push(messageDiv);
            // 2. Cố gắng xử lý hàng đợi. Nếu MathJax chưa sẵn sàng, nó sẽ không làm gì.
            //    Nếu đã sẵn sàng, nó sẽ render ngay lập tức.
            processMathJaxQueue();

            // Tự động cuộn xuống tin nhắn mới nhất
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Hàm xóa toàn bộ tin nhắn
        function clearChat() {
            chatContainer.innerHTML = '';
            mathJaxRenderQueue = []; // Đảm bảo hàng đợi cũng được xóa
        }
    </script>
</body>
</html>